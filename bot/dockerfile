# bot/Dockerfile
FROM node:18-alpine AS base

# Build stage
FROM base AS builder
WORKDIR /app

# Copy shared module first
COPY shared ./shared

# Install shared dependencies
WORKDIR /app/shared
COPY shared/package*.json ./
RUN npm ci || npm install

# Copy bot application
WORKDIR /app/bot
COPY bot/package*.json ./

# Install bot dependencies (including link to shared)
RUN npm ci || npm install

# Copy bot source code
COPY bot/src ./src
COPY bot/eslint.config.js ./
COPY bot/.eslintrc.cjs ./

# Runtime stage
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

# Create non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 botuser

# Copy the entire app from builder
COPY --from=builder --chown=botuser:nodejs /app/shared ./shared
COPY --from=builder --chown=botuser:nodejs /app/bot ./bot

# Set working directory to bot
WORKDIR /app/bot

USER botuser

EXPOSE 3000

CMD ["node", "src/index.js"]
